#!/usr/bin/env bash

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/lib/env-parser"

readonly DB_TEST_NAME="${DB_TEST_NAME:-yii2basic_test}"
readonly DB_MIGRATION_TEST_NAME="${DB_MIGRATION_TEST_NAME:-}"
readonly DB_DRIVER="${DB_DRIVER:-mysql}"
readonly COMPOSE="${COMPOSE:-docker compose}"

load_db_env

if [ -z "$POSTGRES_USER" ] && [ "$DB_DRIVER" = "pgsql" ]; then
    echo "‚ùå POSTGRES_USER –Ω–µ –∑–∞–¥–∞–Ω (–≤ .env –∏–ª–∏ –æ–∫—Ä—É–∂–µ–Ω–∏–∏)"
    exit 1
fi

readonly DB_ROOT_PASSWORD
readonly DB_USER
readonly DB_PASSWORD
readonly POSTGRES_USER

validate_db_name() {
    local name="$1"
    if ! echo "$name" | grep -qE '^[a-zA-Z0-9_]+$'; then
        echo "‚ùå –û—à–∏–±–∫–∞: –∏–º—è –ë–î —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã. –î–æ–ø—É—Å–∫–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ [a-zA-Z0-9_]"
        exit 1
    fi
}

prepare_mysql() {
    echo "üîß –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –±–∞–∑—ã MySQL..."
    validate_db_name "$DB_TEST_NAME"

    if ! $COMPOSE exec -T -e MYSQL_PWD="$DB_ROOT_PASSWORD" db mysql -uroot -h127.0.0.1 <<EOF
CREATE DATABASE IF NOT EXISTS \`$DB_TEST_NAME\`;
CREATE USER IF NOT EXISTS '$DB_USER'@'%' IDENTIFIED BY '$DB_PASSWORD';
GRANT ALL PRIVILEGES ON \`$DB_TEST_NAME\`.* TO '$DB_USER'@'%';
FLUSH PRIVILEGES;
EOF
    then
        echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ë–î $DB_TEST_NAME"
        exit 1
    fi

    if [ -n "$DB_MIGRATION_TEST_NAME" ]; then
        validate_db_name "$DB_MIGRATION_TEST_NAME"
        if ! $COMPOSE exec -T -e MYSQL_PWD="$DB_ROOT_PASSWORD" db mysql -uroot -h127.0.0.1 <<EOF
CREATE DATABASE IF NOT EXISTS \`$DB_MIGRATION_TEST_NAME\`;
CREATE USER IF NOT EXISTS '$DB_USER'@'%' IDENTIFIED BY '$DB_PASSWORD';
GRANT ALL PRIVILEGES ON \`$DB_MIGRATION_TEST_NAME\`.* TO '$DB_USER'@'%';
FLUSH PRIVILEGES;
EOF
        then
            echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ë–î $DB_MIGRATION_TEST_NAME"
            exit 1
        fi
    fi
}

prepare_pgsql() {
    echo "üîß –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –±–∞–∑—ã PostgreSQL..."
    validate_db_name "$DB_TEST_NAME"

    if ! $COMPOSE exec -T pgsql psql -v ON_ERROR_STOP=1 -U "$POSTGRES_USER" -d postgres <<EOF
SELECT pg_terminate_backend(pid)
FROM pg_stat_activity
WHERE datname = '$DB_TEST_NAME' AND pid <> pg_backend_pid();

DROP DATABASE IF EXISTS "$DB_TEST_NAME";
CREATE DATABASE "$DB_TEST_NAME";
EOF
    then
        echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ë–î $DB_TEST_NAME"
        exit 1
    fi

    if [ -n "$DB_MIGRATION_TEST_NAME" ]; then
        validate_db_name "$DB_MIGRATION_TEST_NAME"
        if ! $COMPOSE exec -T pgsql psql -v ON_ERROR_STOP=1 -U "$POSTGRES_USER" -d postgres <<EOF
SELECT pg_terminate_backend(pid)
FROM pg_stat_activity
WHERE datname = '$DB_MIGRATION_TEST_NAME' AND pid <> pg_backend_pid();

DROP DATABASE IF EXISTS "$DB_MIGRATION_TEST_NAME";
CREATE DATABASE "$DB_MIGRATION_TEST_NAME";
EOF
        then
            echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ë–î $DB_MIGRATION_TEST_NAME"
            exit 1
        fi
    fi
}

run_migrations() {
    echo "üîÑ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π..."
    if ! $COMPOSE exec -T php sh -c "DB_NAME=$DB_TEST_NAME ./yii migrate --interactive=0 --migrationPath=@app/migrations"; then
        echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–π"
        exit 1
    fi
}

case "$DB_DRIVER" in
    pgsql)
        prepare_pgsql
        ;;
    mysql|*)
        prepare_mysql
        ;;
esac

run_migrations

echo "‚úÖ –¢–µ—Å—Ç–æ–≤–∞—è –±–∞–∑–∞ –≥–æ—Ç–æ–≤–∞ ($DB_DRIVER: $DB_TEST_NAME)"
