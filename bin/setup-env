#!/usr/bin/env php
<?php

declare(strict_types=1);

/**
 * Ð˜Ð½Ñ‚ÐµÑ€Ð°ÐºÑ‚Ð¸Ð²Ð½Ð°Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ.
 */

final class EnvSetup
{
    private const string COLOR_RESET = "\033[0m";
    private const string COLOR_GREEN = "\033[32m";
    private const string COLOR_YELLOW = "\033[33m";
    private const string COLOR_CYAN = "\033[36m";
    private const string COLOR_BOLD = "\033[1m";

    private const array FORCED_KEYS = ['APP_PORT', 'UID', 'GID'];

    public function __construct(
        private readonly string $rootPath
    ) {
    }

    public function run(array $argv): void
    {
        $autoYes = in_array('-y', $argv, true) || in_array('--yes', $argv, true);
        $examplePath = $this->rootPath . '/.env.example';
        $targetPath = $this->rootPath . '/.env';

        if (!file_exists($examplePath)) {
            $this->error("Ð¤Ð°Ð¹Ð» .env.example Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½!");
            exit(1);
        }

        $this->header("ðŸš€ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ");

        $isTty = stream_isatty(fopen('php://stdin', 'r'));
        if (!$autoYes && $isTty) {
            echo "Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ Ð´Ð»Ñ Ð²ÑÐµÑ… Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð¾Ð²? (ÐºÑ€Ð¾Ð¼Ðµ ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ñ‹Ñ…) [y/N]: ";
            $input = $this->readInput();
            if (strtolower($input) === 'y') {
                $autoYes = true;
            }
            echo "\n";
        }

        $currentValues = $this->loadCurrentEnv($targetPath);
        $lines = file($examplePath, FILE_IGNORE_NEW_LINES);
        $newContent = [];

        foreach ($lines as $line) {
            $trimmed = trim($line);

            if ($this->isCommentOrEmpty($trimmed)) {
                $newContent[] = $line;
                if (str_contains($line, '==')) {
                    $this->section($line);
                }
                continue;
            }

            if (!str_contains($line, '=')) {
                $newContent[] = $line;
                continue;
            }

            [$key, $defaultRaw] = explode('=', $line, 2);
            $key = trim($key);

            $default = $this->getEffectiveDefault($key, $defaultRaw);
            $current = $currentValues[$key] ?? $default;

            $forceAsk = in_array($key, self::FORCED_KEYS, true) && $isTty;

            if ($autoYes && !$forceAsk) {
                echo sprintf("âœ… %s=%s\n", $key, $current);
                $value = $current;
            } else {
                $this->printKeyHint($key);
                $value = $this->prompt($key, $current);
            }

            $newContent[] = "{$key}={$value}";
        }

        if ($autoYes || $this->shouldSave($targetPath)) {
            file_put_contents($targetPath, implode("\n", $newContent) . "\n");
            $this->success("Ð¤Ð°Ð¹Ð» .env ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½!");
        } else {
            $this->warning("ÐžÑ‚Ð¼ÐµÐ½ÐµÐ½Ð¾. Ð¤Ð°Ð¹Ð» Ð½Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½.");
        }
    }

    private function getEffectiveDefault(string $key, string $defaultRaw): string
    {
        $hostDefault = $this->getHostDefault($key);
        if ($hostDefault !== null) {
            return $hostDefault;
        }

        return trim(explode('#', $defaultRaw)[0]);
    }

    private function getHostDefault(string $key): string|null
    {
        return match ($key) {
            'UID' => trim((string) shell_exec('id -u')) ?: '1000',
            'GID' => trim((string) shell_exec('id -g')) ?: '1000',
            default => null,
        };
    }

    private function printKeyHint(string $key): void
    {
        $hint = match ($key) {
            'APP_PORT' => 'ðŸ‘‰ Ð’Ð½Ð¸Ð¼Ð°Ð½Ð¸Ðµ: Ð²Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑÐ²Ð¾Ð±Ð¾Ð´Ð½Ñ‹Ð¹ Ð¿Ð¾Ñ€Ñ‚ Ð´Ð»Ñ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ!',
            'UID' => 'ðŸ‘‰ Docker user ID (Ð°Ð²Ñ‚Ð¾Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ñ‘Ð½ Ð¸Ð· Ñ…Ð¾ÑÑ‚Ð°)',
            'GID' => 'ðŸ‘‰ Docker group ID (Ð°Ð²Ñ‚Ð¾Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ñ‘Ð½ Ð¸Ð· Ñ…Ð¾ÑÑ‚Ð°)',
            default => null,
        };

        if ($hint === null) {
            return;
        }

        echo self::COLOR_YELLOW . $hint . self::COLOR_RESET . "\n";
    }

    /**
     * @return array<string, string>
     */
    private function loadCurrentEnv(string $path): array
    {
        if (!file_exists($path)) {
            return [];
        }

        $this->warning("âš ï¸  ÐÐ°Ð¹Ð´ÐµÐ½ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¹ .env");
        $values = [];
        $lines = file($path, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);

        foreach ($lines as $line) {
            $line = trim($line);
            if (str_starts_with($line, '#') || !str_contains($line, '=')) {
                continue;
            }
            [$key, $val] = explode('=', $line, 2);
            $values[trim($key)] = trim($val);
        }

        return $values;
    }

    private function prompt(string $key, string $default): string
    {
        echo sprintf(
            "ðŸ“ %s [%s]: ",
            $key,
            self::COLOR_GREEN . $default . self::COLOR_RESET
        );

        $input = $this->readInput();
        return $input === '' ? $default : $input;
    }

    private function readInput(): string
    {
        $handle = fopen("php://stdin", "r");
        $input = fgets($handle);
        fclose($handle);

        return $input === false ? '' : trim($input);
    }

    private function shouldSave(string $path): bool
    {
        echo "\n------------------------------------------------\n";
        if (!file_exists($path)) {
            return true;
        }

        echo "ÐŸÐµÑ€ÐµÐ·Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒ .env? [y/N]: ";
        $input = $this->readInput();

        return strtolower($input) === 'y';
    }

    private function isCommentOrEmpty(string $line): bool
    {
        return $line === '' || str_starts_with($line, '#');
    }

    private function header(string $text): void
    {
        echo "\n" . self::COLOR_BOLD . $text . self::COLOR_RESET . "\n";
        echo "------------------------------------------------\n";
    }

    private function section(string $text): void
    {
        echo "\n" . self::COLOR_CYAN . $text . self::COLOR_RESET . "\n";
    }

    private function success(string $text): void
    {
        echo "\n" . self::COLOR_GREEN . "âœ… " . $text . self::COLOR_RESET . "\n";
    }

    private function warning(string $text): void
    {
        echo self::COLOR_YELLOW . $text . self::COLOR_RESET . "\n";
    }

    private function error(string $text): void
    {
        echo "\nâŒ " . $text . "\n";
    }
}

(new EnvSetup(__DIR__ . '/..'))->run($argv);
