#!/usr/bin/env php
<?php

declare(strict_types=1);

/**
 * –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è.
 */

final class EnvSetup
{
    private const string COLOR_RESET = "\033[0m";
    private const string COLOR_GREEN = "\033[32m";
    private const string COLOR_YELLOW = "\033[33m";
    private const string COLOR_CYAN = "\033[36m";
    private const string COLOR_BOLD = "\033[1m";

    public function __construct(
        private readonly string $rootPath
    ) {
    }

    public function run(array $argv): void
    {
        $autoYes = in_array('-y', $argv, true) || in_array('--yes', $argv, true);
        $examplePath = $this->rootPath . '/.env.example';
        $targetPath = $this->rootPath . '/.env';

        if (!file_exists($examplePath)) {
            $this->error("–§–∞–π–ª .env.example –Ω–µ –Ω–∞–π–¥–µ–Ω!");
            exit(1);
        }

        $this->header("üöÄ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è");

        $isTty = stream_isatty(fopen('php://stdin', 'r'));
        if (!$autoYes && $isTty) {
            echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –≤—Å–µ—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤? (–∫—Ä–æ–º–µ APP_PORT) [y/N]: ";
            $input = $this->readInput();
            if (strtolower($input) === 'y') {
                $autoYes = true;
            }
            echo "\n";
        }

        $currentValues = $this->loadCurrentEnv($targetPath);
        $lines = file($examplePath, FILE_IGNORE_NEW_LINES);
        $newContent = [];

        foreach ($lines as $line) {
            $trimmed = trim($line);

            if ($this->isCommentOrEmpty($trimmed)) {
                $newContent[] = $line;
                if (str_contains($line, '==')) {
                    $this->section($line);
                }
                continue;
            }

            if (!str_contains($line, '=')) {
                $newContent[] = $line;
                continue;
            }

            [$key, $defaultRaw] = explode('=', $line, 2);
            $key = trim($key);
            
            $default = trim(explode('#', $defaultRaw)[0]);

            $current = $currentValues[$key] ?? $default;

            $forceAsk = $key === 'APP_PORT' && $isTty;

            if ($autoYes && !$forceAsk) {
                if ($key === 'APP_PORT') {
                     echo sprintf("‚ö†Ô∏è  APP_PORT=%s (default)\n", $current);
                } else {
                     echo sprintf("‚úÖ %s=%s\n", $key, $current);
                }
                $value = $current;
            } else {
                if ($key === 'APP_PORT') {
                    echo self::COLOR_YELLOW . "üëâ –í–Ω–∏–º–∞–Ω–∏–µ: –≤—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ–±–æ–¥–Ω—ã–π –ø–æ—Ä—Ç –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è!" . self::COLOR_RESET . "\n";
                }
                $value = $this->prompt($key, $current);
            }
            
            $newContent[] = "{$key}={$value}";
        }

        if ($autoYes || $this->shouldSave($targetPath)) {
            file_put_contents($targetPath, implode("\n", $newContent) . "\n");
            $this->success("–§–∞–π–ª .env —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!");
        } else {
            $this->warning("–û—Ç–º–µ–Ω–µ–Ω–æ. –§–∞–π–ª –Ω–µ –∏–∑–º–µ–Ω–µ–Ω.");
        }
    }

    /**
     * @return array<string, string>
     */
    private function loadCurrentEnv(string $path): array
    {
        if (!file_exists($path)) {
            return [];
        }

        $this->warning("‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π .env");
        $values = [];
        $lines = file($path, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);

        foreach ($lines as $line) {
            $line = trim($line);
            if (str_starts_with($line, '#') || !str_contains($line, '=')) {
                continue;
            }
            [$key, $val] = explode('=', $line, 2);
            $values[trim($key)] = trim($val);
        }

        return $values;
    }

    private function prompt(string $key, string $default): string
    {
        echo sprintf(
            "üìù %s [%s]: ",
            $key,
            self::COLOR_GREEN . $default . self::COLOR_RESET
        );

        $input = $this->readInput();
        return $input === '' ? $default : $input;
    }

    private function readInput(): string
    {
        $handle = fopen("php://stdin", "r");
        $input = fgets($handle);
        fclose($handle);

        return $input === false ? '' : trim($input);
    }

    private function shouldSave(string $path): bool
    {
        echo "\n------------------------------------------------\n";
        if (!file_exists($path)) {
            return true;
        }

        echo "–ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å .env? [y/N]: ";
        $input = $this->readInput();

        return strtolower($input) === 'y';
    }

    private function isCommentOrEmpty(string $line): bool
    {
        return $line === '' || str_starts_with($line, '#');
    }

    private function header(string $text): void
    {
        echo "\n" . self::COLOR_BOLD . $text . self::COLOR_RESET . "\n";
        echo "------------------------------------------------\n";
    }

    private function section(string $text): void
    {
        echo "\n" . self::COLOR_CYAN . $text . self::COLOR_RESET . "\n";
    }

    private function success(string $text): void
    {
        echo "\n" . self::COLOR_GREEN . "‚úÖ " . $text . self::COLOR_RESET . "\n";
    }

    private function warning(string $text): void
    {
        echo self::COLOR_YELLOW . $text . self::COLOR_RESET . "\n";
    }

    private function error(string $text): void
    {
        echo "\n‚ùå " . $text . "\n";
    }
}

(new EnvSetup(__DIR__ . '/..'))->run($argv);
