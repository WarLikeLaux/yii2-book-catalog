#!/usr/bin/env bash

set -euo pipefail

readonly ROOT_DIR="$(cd "$(dirname "$0")/.." && pwd)"
readonly SOURCE_FILE="CLAUDE.md"

readonly SYMLINKS=(
    "GEMINI.md"
    "AGENTS.md"
    "GROK.md"
    ".cursorrules"
    ".clinerules"
    ".windsurfrules"
)

readonly NESTED_DIRS=(
    ".agent/rules:rules.md"
)

cd "$ROOT_DIR"

if [[ ! -f "$SOURCE_FILE" ]]; then
    echo "‚ö†Ô∏è  –§–∞–π–ª $SOURCE_FILE –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–ø—É—Å–∫–∞—é —Å–æ–∑–¥–∞–Ω–∏–µ —Å–∏–º–ª–∏–Ω–∫–æ–≤."
    exit 0
fi

echo "üîó –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏–º–ª–∏–Ω–∫–æ–≤ –¥–ª—è AI –∞–≥–µ–Ω—Ç–æ–≤..."

for link in "${SYMLINKS[@]}"; do
    ln -sf "$SOURCE_FILE" "$link"
done

for entry in "${NESTED_DIRS[@]}"; do
    dir="${entry%%:*}"
    file="${entry##*:}"
    mkdir -p "$dir"

    depth=$(echo "$dir" | tr -cd '/' | wc -c)
    prefix=""
    for ((i = 0; i <= depth; i++)); do
        prefix="../$prefix"
    done

    ln -sf "${prefix}${SOURCE_FILE}" "$dir/$file"
done

derived_paths=()
for entry in "${NESTED_DIRS[@]}"; do
    dir="${entry%%:*}"
    file="${entry##*:}"
    derived_paths+=("$dir/$file")
done

echo "‚úÖ –°–∏–º–ª–∏–Ω–∫–∏ —Å–æ–∑–¥–∞–Ω—ã: ${SYMLINKS[*]}, ${derived_paths[*]} -> $SOURCE_FILE"

echo "üìÇ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–ª–∏–∞—Å–æ–≤ –¥–ª—è Skills..."
mkdir -p .agent/skills
mkdir -p .claude
mkdir -p .codex
mkdir -p .cursor

ln -sfT ../.agent/skills .claude/skills
ln -sfT ../.agent/skills .codex/skills
ln -sfT ../.agent/skills .cursor/skills

mkdir -p "$HOME/.claude" 2>/dev/null || true
ln -sf "$ROOT_DIR/.agent/skills" "$HOME/.claude/skills" 2>/dev/null || true

echo "‚úÖ –ê–ª–∏–∞—Å—ã –¥–ª—è skills –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã: .claude/skills, .codex/skills, ~/.claude/skills -> .agent/skills"
