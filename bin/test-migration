#!/usr/bin/env bash

set -euo pipefail

DB_MIGRATION_TEST_NAME="${DB_MIGRATION_TEST_NAME:-}"
DB_DRIVER="${DB_DRIVER:-}"
COMPOSE="${COMPOSE:-docker compose}"
DB_ROOT_PASSWORD="${DB_ROOT_PASSWORD:-}"
DB_USER="${DB_USER:-}"
DB_PASSWORD="${DB_PASSWORD:-}"
POSTGRES_USER="${POSTGRES_USER:-}"

if [ -z "$DB_MIGRATION_TEST_NAME" ] && [ -f .env ]; then
    DB_MIGRATION_TEST_NAME="$(grep -E '^DB_MIGRATION_TEST_NAME=' .env | head -n1 | cut -d= -f2- || true)"
fi

if [ -z "$DB_DRIVER" ] && [ -f .env ]; then
    DB_DRIVER="$(grep -E '^DB_DRIVER=' .env | head -n1 | cut -d= -f2- || true)"
fi

if [ -z "$DB_DRIVER" ]; then
    DB_DRIVER="mysql"
fi

if [ -f .env ]; then
    DB_ROOT_PASSWORD="${DB_ROOT_PASSWORD:-$(grep -E '^DB_ROOT_PASSWORD=' .env | cut -d= -f2- || true)}"
    DB_USER="${DB_USER:-$(grep -E '^DB_USER=' .env | cut -d= -f2- || true)}"
    DB_PASSWORD="${DB_PASSWORD:-$(grep -E '^DB_PASSWORD=' .env | cut -d= -f2- || true)}"
    POSTGRES_USER="${POSTGRES_USER:-$(grep -E '^POSTGRES_USER=' .env | cut -d= -f2- || true)}"
fi

DB_ROOT_PASSWORD="${DB_ROOT_PASSWORD:-root}"
DB_USER="${DB_USER:-yii2}"
DB_PASSWORD="${DB_PASSWORD:-secret}"

if [ -z "$DB_MIGRATION_TEST_NAME" ]; then
    echo "DB_MIGRATION_TEST_NAME не задан (в .env или окружении)."
    exit 1
fi

if ! echo "$DB_MIGRATION_TEST_NAME" | grep -qE '^[a-zA-Z0-9_]+$'; then
    echo "❌ Ошибка: DB_MIGRATION_TEST_NAME содержит недопустимые символы. Допускаются только [a-zA-Z0-9_]"
    exit 1
fi

if [ -z "$POSTGRES_USER" ] && [ "$DB_DRIVER" = "pgsql" ]; then
    echo "❌ POSTGRES_USER не задан (в .env или окружении)"
    exit 1
fi

export DB_MIGRATION_TEST_NAME

if [ "$DB_DRIVER" = "pgsql" ]; then
    if ! $COMPOSE exec -T pgsql psql -U "$POSTGRES_USER" -d postgres <<EOF
DROP DATABASE IF EXISTS "$DB_MIGRATION_TEST_NAME";
CREATE DATABASE IF NOT EXISTS "$DB_MIGRATION_TEST_NAME";
EOF
    then
        echo "❌ Ошибка при создании тестовой БД PostgreSQL"
        exit 1
    fi
else
    if ! $COMPOSE exec -T -e MYSQL_PWD="$DB_ROOT_PASSWORD" db mysql -uroot -h127.0.0.1 <<EOF
DROP DATABASE IF EXISTS \`$DB_MIGRATION_TEST_NAME\`;
CREATE DATABASE \`$DB_MIGRATION_TEST_NAME\`;
CREATE USER IF NOT EXISTS '$DB_USER'@'%' IDENTIFIED BY '$DB_PASSWORD';
GRANT ALL PRIVILEGES ON \`$DB_MIGRATION_TEST_NAME\`.* TO '$DB_USER'@'%';
FLUSH PRIVILEGES;
EOF
    then
        echo "❌ Ошибка при создании тестовой БД MySQL"
        exit 1
    fi
fi

bin/test-db-prepare
$COMPOSE exec -T php sh -c "DB_MIGRATION_TEST_NAME=$DB_MIGRATION_TEST_NAME ./vendor/bin/codecept run integration MigrationReversibilityTest"
