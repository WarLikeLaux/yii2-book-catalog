#!/usr/bin/env php
<?php

declare(strict_types=1);

final class CoverageReportGenerator
{
    private const string C_RESET = "\033[0m";
    private const string C_RED = "\033[1;31m";
    private const string C_GREEN = "\033[32m";

    public function __construct(
        private readonly string $rootPath,
        private readonly string $coverageXmlPath,
        private readonly string $coverageTxtPath
    ) {
    }

    public function run(): int
    {
        if (!file_exists($this->coverageXmlPath)) {
            echo "âš ï¸  Ğ¤Ğ°Ğ¹Ğ» coverage.xml Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½. Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğµ 'make test' Ğ´Ğ»Ñ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸.\n";
            return 1;
        }

        $this->printSummary();
        $this->printUncoveredLines();
        $this->printFooter();

        return 0;
    }

    private function printSummary(): void
    {
        echo "----------------------------------------------------------------------\n";

        if (file_exists($this->coverageTxtPath)) {
            $lines = file($this->coverageTxtPath, FILE_IGNORE_NEW_LINES);
            if ($lines !== false) {
                $output = array_slice($lines, 0, 9);
                echo implode("\n", $output) . "\n";
            }
        }

        echo "----------------------------------------------------------------------\n";
    }

    private function printUncoveredLines(): void
    {
        $xml = simplexml_load_file($this->coverageXmlPath);
        if ($xml === false) {
            echo "âŒ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ coverage.xml\n";
            return;
        }

        $uncovered = [];

        foreach ($xml->project->xpath('//file') as $file) {
            $missedLines = [];

            foreach ($file->line as $line) {
                $count = (string) $line['count'];
                $type = (string) $line['type'];

                if ($count === '0' && $type === 'stmt') {
                    $missedLines[] = (string) $line['num'];
                }
            }

            if (!empty($missedLines)) {
                $fileName = str_replace($this->rootPath . '/', '', (string) $file['name']);
                $uncovered[$fileName] = $missedLines;
            }
        }

        if (empty($uncovered)) {
            echo self::C_GREEN . "âœ… Ğ’ÑĞµ ÑÑ‚Ñ€Ğ¾ĞºĞ¸ Ğ¿Ğ¾ĞºÑ€Ñ‹Ñ‚Ñ‹ Ñ‚ĞµÑÑ‚Ğ°Ğ¼Ğ¸!" . self::C_RESET . "\n";
            return;
        }

        echo "ğŸ” ĞĞµĞ¿Ğ¾ĞºÑ€Ñ‹Ñ‚Ñ‹Ğµ ÑÑ‚Ñ€Ğ¾ĞºĞ¸:\n";

        foreach ($uncovered as $fileName => $lines) {
            echo self::C_RED . "âœ˜ " . $fileName . self::C_RESET . "\n";
            echo "   Lines: " . implode(', ', $lines) . "\n";
        }

        echo "----------------------------------------------------------------------\n";
    }

    private function printFooter(): void
    {
        echo "ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ¾Ñ‚Ñ‡ĞµÑ‚: tests/_output/coverage/index.html\n";
    }
}

$rootPath = dirname(__DIR__);
$outputDir = $rootPath . '/tests/_output';

$generator = new CoverageReportGenerator(
    $rootPath,
    $outputDir . '/coverage.xml',
    $outputDir . '/coverage.txt'
);

exit($generator->run());
