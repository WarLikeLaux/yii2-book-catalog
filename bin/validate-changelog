#!/usr/bin/env php
<?php

declare(strict_types=1);

/**
 * Ð’Ð°Ð»Ð¸Ð´Ð°Ñ‚Ð¾Ñ€ CHANGELOG.md Ð½Ð° ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ðµ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð°Ð¼ Ð¸ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ðµ.
 */

final class ChangelogValidator
{
    /** @var string[] */
    private array $errors = [];
    /** @var string[] */
    private array $warnings = [];

    public function __construct(
        private readonly string $rootPath
    ) {
    }

    public function run(): void
    {
        $changelogPath = $this->rootPath . '/CHANGELOG.md';

        if (!file_exists($changelogPath)) {
            $this->error("Ð¤Ð°Ð¹Ð» CHANGELOG.md Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½: $changelogPath");
            exit(1);
        }

        $content = file_get_contents($changelogPath);
        if ($content === false) {
             $this->error("ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ñ‚ÑŒ CHANGELOG.md");
             exit(1);
        }

        echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° CHANGELOG.md...\n";

        $this->validateStructureAndHashes($content);
        $this->validateCommits($content);

        $this->printResults();

        if (!empty($this->errors)) {
            exit(1);
        }
    }

    private function validateStructureAndHashes(string $content): void
    {
        $lines = explode("\n", $content);
        $currentVersion = null;
        /** @var array<string, array<int, string>> $versionSections */
        $versionSections = [];
        $mentionedHashes = [];

        foreach ($lines as $lineNum => $line) {
            if (preg_match('/^## \[(.*?)\]/', $line, $matches)) {
                $currentVersion = $matches[1];
                $versionSections[$currentVersion] = [];
                continue;
            }

            if ($currentVersion !== null && preg_match('/^### (.*)/', $line, $matches)) {
                $section = trim($matches[1]);
                if (in_array($section, $versionSections[$currentVersion], true)) {
                    $this->errors[] = "Ð”ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ‚ ÑÐµÐºÑ†Ð¸Ð¸ '{$section}' Ð² Ð²ÐµÑ€ÑÐ¸Ð¸ [{$currentVersion}] Ð½Ð° ÑÑ‚Ñ€Ð¾ÐºÐµ " . ($lineNum + 1);
                } else {
                    $versionSections[$currentVersion][] = $section;
                }
            }

            if (preg_match_all('/\[([a-f0-9]{7,40})\]/', $line, $matches)) {
                foreach ($matches[1] as $hash) {
                    if (ctype_xdigit($hash)) {
                        $mentionedHashes[] = $hash;
                    }
                }
            }
        }

        $this->verifyHashesInGit(array_unique($mentionedHashes));
    }

    /**
     * @param string[] $hashes
     */
    private function verifyHashesInGit(array $hashes): void
    {
        foreach ($hashes as $hash) {
            if (str_contains($hash, '.')) {
                continue;
            }

            $command = "git cat-file -t " . escapeshellarg($hash) . " 2>/dev/null";
            exec($command, $output, $returnVar);

            if ($returnVar !== 0) {
                $this->errors[] = "Ð¥ÐµÑˆ '{$hash}' ÑƒÐºÐ°Ð·Ð°Ð½Ð½Ñ‹Ð¹ Ð² CHANGELOG Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² git.";
            }
        }
    }

    private function validateCommits(string $content): void
    {
        echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ñ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð¾Ð²...\n";

        exec('git log --format="%h|%s" -n 100', $gitLog);
        $missingCommits = [];

        foreach ($gitLog as $logLine) {
            if (!str_contains($logLine, '|')) {
                continue;
            }
            [$shortHash, $message] = explode('|', $logLine, 2);

            if ($this->shouldSkipCommit($message)) {
                continue;
            }

            if (!str_contains($content, $shortHash)) {
                $missingCommits[] = "$shortHash - $message";
            }
        }

        if (!empty($missingCommits)) {
            $this->warnings[] = "ÐÐ°Ð¹Ð´ÐµÐ½Ñ‹ Ð½ÐµÐ´Ð°Ð²Ð½Ð¸Ðµ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ñ‹, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ñ… ÐÐ•Ð¢ Ð² CHANGELOG (Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 100):\n   - " . implode("\n   - ", $missingCommits);
        }
    }

    private function shouldSkipCommit(string $message): bool
    {
        if (stripos($message, 'changelog') !== false && stripos($message, 'update') !== false) {
            return true;
        }
        if (str_starts_with($message, 'tools:') || str_starts_with($message, 'style:') || str_starts_with($message, 'docs:')) {
            return true;
        }
        if (str_starts_with($message, 'Merge branch')) {
            return true;
        }
        return false;
    }

    private function printResults(): void
    {
        if (!empty($this->errors)) {
            echo "\nâŒ ÐÐ°Ð¹Ð´ÐµÐ½Ñ‹ Ð¾ÑˆÐ¸Ð±ÐºÐ¸:\n";
            foreach ($this->errors as $error) {
                echo "   - $error\n";
            }
        }

        if (!empty($this->warnings)) {
            echo "\nâš ï¸  ÐŸÑ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ñ:\n";
            foreach ($this->warnings as $warning) {
                echo "   - $warning\n";
            }
        }

        if (empty($this->errors)) {
            echo "\nâœ… Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° CHANGELOG Ð¸ Ñ…ÐµÑˆÐ¸ Ð²Ð°Ð»Ð¸Ð´Ð½Ñ‹.\n";
        }
    }

    private function error(string $text): void
    {
        echo "\nâŒ " . $text . "\n";
    }
}

(new ChangelogValidator(__DIR__ . '/..'))->run();
