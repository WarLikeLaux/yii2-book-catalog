#!/usr/bin/env php
<?php

declare(strict_types=1);

$changelogPath = __DIR__ . '/../CHANGELOG.md';

if (!file_exists($changelogPath)) {
    echo "‚ùå –û—à–∏–±–∫–∞: –§–∞–π–ª CHANGELOG.md –Ω–µ –Ω–∞–π–¥–µ–Ω: $changelogPath\n";
    exit(1);
}

$content = file_get_contents($changelogPath);
$lines = explode("\n", $content);

$errors = [];
$warnings = [];

echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ CHANGELOG.md...\n";

$currentVersion = null;
$versionSections = [];
$mentionedHashes = [];

foreach ($lines as $lineNum => $line) {
    if (preg_match('/^## \[(.*?)\]/', $line, $matches)) {
        $currentVersion = $matches[1];
        $versionSections[$currentVersion] = [];
        continue;
    }

    if ($currentVersion && preg_match('/^### (.*)/', $line, $matches)) {
        $section = trim($matches[1]);
        if (in_array($section, $versionSections[$currentVersion], true)) {
            $errors[] = "–î—É–±–ª–∏–∫–∞—Ç —Å–µ–∫—Ü–∏–∏ '{$section}' –≤ –≤–µ—Ä—Å–∏–∏ [{$currentVersion}] –Ω–∞ —Å—Ç—Ä–æ–∫–µ " . ($lineNum + 1);
        } else {
            $versionSections[$currentVersion][] = $section;
        }
    }

    if (preg_match_all('/\[([a-f0-9]{7,40})\]/', $line, $matches)) {
        foreach ($matches[1] as $hash) {
            if (ctype_xdigit($hash)) {
                $mentionedHashes[] = $hash;
            }
        }
    }
}

$uniqueHashes = array_unique($mentionedHashes);
foreach ($uniqueHashes as $hash) {
    if (strpos($hash, '.') !== false) {
        continue;
    }

    $command = "git cat-file -t " . escapeshellarg($hash) . " 2>/dev/null";
    exec($command, $output, $returnVar);
    
    if ($returnVar !== 0) {
        $errors[] = "–•–µ—à '{$hash}' —É–∫–∞–∑–∞–Ω–Ω—ã–π –≤ CHANGELOG –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ git.";
    }
}

echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∫–æ–º–º–∏—Ç–æ–≤...\n";

exec('git log --format="%h|%s" -n 30', $gitLog);
$missingCommits = [];

foreach ($gitLog as $logLine) {
    [$shortHash, $message] = explode('|', $logLine, 2);
    
    if (stripos($message, 'changelog') !== false && stripos($message, 'update') !== false) {
        continue;
    }
    if (str_starts_with($message, 'tools:') || str_starts_with($message, 'style:') || str_starts_with($message, 'docs:')) {
        continue;
    }
    if (str_starts_with($message, 'Merge branch')) {
        continue;
    }

    if (strpos($content, $shortHash) === false) {
        $missingCommits[] = "$shortHash - $message";
    }
}

if (!empty($missingCommits)) {
    $warnings[] = "–ù–∞–π–¥–µ–Ω—ã –Ω–µ–¥–∞–≤–Ω–∏–µ –∫–æ–º–º–∏—Ç—ã, –∫–æ—Ç–æ—Ä—ã—Ö –ù–ï–¢ –≤ CHANGELOG (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 30):\n   - " . implode("\n   - ", $missingCommits);
}

if (!empty($errors)) {
    echo "\n‚ùå –ù–∞–π–¥–µ–Ω—ã –æ—à–∏–±–∫–∏:\n";
    foreach ($errors as $error) {
        echo "   - $error\n";
    }
}

if (!empty($warnings)) {
    echo "\n‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:\n";
    foreach ($warnings as $warning) {
        echo "   - $warning\n";
    }
}

if (empty($errors)) {
    echo "\n‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ CHANGELOG –∏ —Ö–µ—à–∏ –≤–∞–ª–∏–¥–Ω—ã.\n";
}

if (!empty($errors)) {
    exit(1);
}
