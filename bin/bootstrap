#!/usr/bin/env bash

set -euo pipefail

readonly ROOT_DIR="$(cd "$(dirname "$0")/.." && pwd)"

cd "$ROOT_DIR"

show_help() {
    cat << 'EOF'
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: bin/bootstrap [–∫–æ–º–∞–Ω–¥–∞]

–ö–æ–º–∞–Ω–¥—ã:
  init        –ü–æ–ª–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞ (–∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ)
  init-force  –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (–±–µ–∑ –≤–æ–ø—Ä–æ—Å–æ–≤)
  setup       –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–ø—Ä–∞–≤–∞, –ø–∞–ø–∫–∏, .env)
  configure   –ü–µ—Ä–µ–Ω–∞—Å—Ç—Ä–æ–π–∫–∞ .env (–∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ)

–ë–µ–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤: –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É.
EOF
}

confirm() {
    local message="$1"
    echo ""
    echo "======================================================================"
    echo "$message"
    echo "======================================================================"
    read -r -p "   –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? [y/N] " ans
    if [[ ! "$ans" =~ ^[yY]$ ]]; then
        echo "‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º."
        exit 1
    fi
}

ensure_dirs() {
    mkdir -p web/uploads runtime/debug runtime/logs runtime/cache runtime/sessions
}

ensure_permissions() {
    echo "üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤..."
    ./bin/fix-perms
}

ensure_scripts_executable() {
    chmod +x bin/*
}

setup_env() {
    local force="${1:-}"

    if [[ "$force" == "-y" ]]; then
        ./bin/setup-env -y
        return
    fi

    if [[ -f .env ]]; then
        echo "‚ùì –§–∞–π–ª .env –Ω–∞–π–¥–µ–Ω."
        read -r -p "   –ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å –µ–≥–æ (—Å–±—Ä–æ—Å–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)? [y/N] " ans
        if [[ "$ans" =~ ^[yY]$ ]]; then
            ./bin/setup-env
        else
            echo "‚úÖ .env –æ—Å—Ç–∞–≤–ª–µ–Ω –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π."
        fi
    else
        ./bin/setup-env -y
    fi
}

print_banner() {
    local app_port
    local bug_port
    app_port=$(grep '^APP_PORT=' .env 2>/dev/null | cut -d '=' -f2 | tr -d '"' | tr -d ' ' || echo 8000)
    bug_port=$(grep '^BUGGREGATOR_UI_PORT=' .env 2>/dev/null | cut -d '=' -f2 | tr -d '"' | tr -d ' ' || echo 9913)

    echo ""
    echo "======================================================================"
    echo "üöÄ –ü–†–û–ï–ö–¢ –ì–û–¢–û–í –ö –†–ê–ë–û–¢–ï"
    echo "======================================================================"
    echo "üåç –°–∞–π—Ç:        http://localhost:$app_port"
    echo "üìÑ API Docs:    http://localhost:$app_port/api"
    echo "üêû Buggregator: http://localhost:$bug_port"
    echo "======================================================================"
}

cmd_setup() {
    ensure_permissions
    ./bin/agent-links
    ensure_dirs
    ensure_scripts_executable
    setup_env
}

cmd_configure() {
    confirm "‚ö†Ô∏è  –ü–û–õ–ù–ê–Ø –ü–ï–†–ï–ù–ê–°–¢–†–û–ô–ö–ê –û–ö–†–£–ñ–ï–ù–ò–Ø"
    ensure_permissions
    ensure_dirs
    ensure_scripts_executable
    ./bin/setup-env
}

cmd_init() {
    confirm "üö®  –ü–û–õ–ù–ê–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–û–ï–ö–¢–ê

–ë—É–¥—É—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è:
  1. üõ†  –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–ø—Ä–∞–≤–∞, –ø–∞–ø–∫–∏, .env)
  2. üîó –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏–º–ª–∏–Ω–∫–æ–≤ –¥–ª—è AI –∞–≥–µ–Ω—Ç–æ–≤
  3. üê≥ –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –∏ –∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
  4. üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (composer install)
  5. üóÑ  –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –∏ –∑–∞–ª–∏–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö"

    cmd_setup
    make up
    make composer
    make migrate
    make seed
    print_banner
}

cmd_init_force() {
    echo "üöÄ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ (–±–µ–∑ –≤–æ–ø—Ä–æ—Å–æ–≤)..."
    ensure_dirs
    ensure_scripts_executable
    ./bin/setup-env -y
    make up
    echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
    # –î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è
    RETRIES=30
    until docker compose exec -T db mysqladmin ping -h localhost --silent >/dev/null 2>&1 || \
          docker compose exec -T pgsql pg_isready -U postgres >/dev/null 2>&1; do
        ((RETRIES--))
        if [ $RETRIES -le 0 ]; then
             echo "‚ùå –û—à–∏–±–∫–∞: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª–∞—Å—å –≤–æ–≤—Ä–µ–º—è."
             exit 1
        fi
        echo -n "."
        sleep 1
    done
    echo " ‚úÖ"
    make composer
    make migrate
    make seed

    local app_port
    app_port=$(grep '^APP_PORT=' .env 2>/dev/null | cut -d '=' -f2 | tr -d '"' | tr -d ' ' || echo 8000)
    echo ""
    echo "‚úÖ –ü—Ä–æ–µ–∫—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: http://localhost:$app_port"
}

case "${1:-}" in
    init)
        cmd_init
        ;;
    init-force)
        cmd_init_force
        ;;
    setup)
        cmd_setup
        ;;
    configure)
        cmd_configure
        ;;
    -h|--help|help|"")
        show_help
        ;;
    *)
        echo "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞: $1"
        show_help
        exit 1
        ;;
esac
