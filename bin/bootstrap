#!/usr/bin/env bash

set -euo pipefail

readonly ROOT_DIR="$(cd "$(dirname "$0")/.." && pwd)"
readonly SCRIPT_NAME="$(basename "$0")"

cd "$ROOT_DIR"

show_help() {
    cat << 'EOF'
Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ: bin/bootstrap [ÐºÐ¾Ð¼Ð°Ð½Ð´Ð°]

ÐšÐ¾Ð¼Ð°Ð½Ð´Ñ‹:
  init        ÐŸÐ¾Ð»Ð½Ð°Ñ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° (Ð¸Ð½Ñ‚ÐµÑ€Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾)
  init-force  ÐŸÑ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ (Ð±ÐµÐ· Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ¾Ð²)
  setup       ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ (Ð¿Ñ€Ð°Ð²Ð°, Ð¿Ð°Ð¿ÐºÐ¸, .env)
  configure   ÐŸÐµÑ€ÐµÐ½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° .env (Ð¸Ð½Ñ‚ÐµÑ€Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾)

Ð‘ÐµÐ· Ð°Ñ€Ð³ÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð²: Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚ ÑÑ‚Ñƒ ÑÐ¿Ñ€Ð°Ð²ÐºÑƒ.
EOF
}

confirm() {
    local message="$1"
    echo ""
    echo "======================================================================"
    echo "$message"
    echo "======================================================================"
    read -p "   ÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ñ‚ÑŒ? [y/N] " ans
    if [[ ! "$ans" =~ ^[yY]$ ]]; then
        echo "âŒ ÐžÑ‚Ð¼ÐµÐ½ÐµÐ½Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¼."
        exit 1
    fi
}

ensure_dirs() {
    mkdir -p web/uploads runtime/debug runtime/logs runtime/cache runtime/sessions
}

ensure_permissions() {
    echo "ðŸ”§ Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð°Ð²..."
    ./bin/fix-perms
}

ensure_scripts_executable() {
    chmod +x bin/*
}

setup_env() {
    local force="${1:-}"

    if [[ "$force" == "-y" ]]; then
        ./bin/setup-env -y
        return
    fi

    if [[ -f .env ]]; then
        echo "â“ Ð¤Ð°Ð¹Ð» .env Ð½Ð°Ð¹Ð´ÐµÐ½."
        read -p "   ÐŸÐµÑ€ÐµÐ·Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒ ÐµÐ³Ð¾ (ÑÐ±Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸)? [y/N] " ans
        if [[ "$ans" =~ ^[yY]$ ]]; then
            ./bin/setup-env
        else
            echo "âœ… .env Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½ Ð±ÐµÐ· Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹."
        fi
    else
        ./bin/setup-env -y
    fi
}

print_banner() {
    local app_port
    local bug_port
    app_port=$(grep '^APP_PORT=' .env | cut -d '=' -f2 | tr -d '"' | tr -d ' ' || echo 8000)
    bug_port=$(grep '^BUGGREGATOR_UI_PORT=' .env | cut -d '=' -f2 | tr -d '"' | tr -d ' ' || echo 9913)

    echo ""
    echo "======================================================================"
    echo "ðŸš€ ÐŸÐ ÐžÐ•ÐšÐ¢ Ð“ÐžÐ¢ÐžÐ’ Ðš Ð ÐÐ‘ÐžÐ¢Ð•"
    echo "======================================================================"
    echo "ðŸŒ Ð¡Ð°Ð¹Ñ‚:        http://localhost:$app_port"
    echo "ðŸ“„ API Docs:    http://localhost:$app_port/api"
    echo "ðŸž Buggregator: http://localhost:$bug_port"
    echo "======================================================================"
}

cmd_setup() {
    ensure_permissions
    ./bin/agent-links
    ensure_dirs
    ensure_scripts_executable
    setup_env
}

cmd_configure() {
    confirm "âš ï¸  ÐŸÐžÐ›ÐÐÐ¯ ÐŸÐ•Ð Ð•ÐÐÐ¡Ð¢Ð ÐžÐ™ÐšÐ ÐžÐšÐ Ð£Ð–Ð•ÐÐ˜Ð¯"
    ensure_permissions
    ensure_dirs
    ensure_scripts_executable
    ./bin/setup-env
}

cmd_init() {
    confirm "ðŸš¨  ÐŸÐžÐ›ÐÐÐ¯ Ð˜ÐÐ˜Ð¦Ð˜ÐÐ›Ð˜Ð—ÐÐ¦Ð˜Ð¯ ÐŸÐ ÐžÐ•ÐšÐ¢Ð

Ð‘ÑƒÐ´ÑƒÑ‚ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ñ‹ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ:
  1. ðŸ›   ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ (Ð¿Ñ€Ð°Ð²Ð°, Ð¿Ð°Ð¿ÐºÐ¸, .env)
  2. ðŸ”— Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÐ¸Ð¼Ð»Ð¸Ð½ÐºÐ¾Ð² Ð´Ð»Ñ AI Ð°Ð³ÐµÐ½Ñ‚Ð¾Ð²
  3. ðŸ³ ÐŸÐµÑ€ÐµÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¸ Ð·Ð°Ð¿ÑƒÑÐº ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²
  4. ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ (composer install)
  5. ðŸ—„  ÐŸÑ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¹ Ð¸ Ð·Ð°Ð»Ð¸Ð²ÐºÐ° Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…"

    cmd_setup
    make up
    make composer
    make migrate
    make seed
    print_banner
}

cmd_init_force() {
    echo "ðŸš€ ÐŸÑ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° (Ð±ÐµÐ· Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ¾Ð²)..."
    ensure_dirs
    ensure_scripts_executable
    ./bin/setup-env -y
    make up
    echo "â³ ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…..."
    sleep 5
    make composer
    make migrate
    make seed

    local app_port
    app_port=$(grep '^APP_PORT=' .env | cut -d '=' -f2 | tr -d '"' | tr -d ' ' || echo 8000)
    echo ""
    echo "âœ… ÐŸÑ€Ð¾ÐµÐºÑ‚ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½: http://localhost:$app_port"
}

case "${1:-}" in
    init)
        cmd_init
        ;;
    init-force)
        cmd_init_force
        ;;
    setup)
        cmd_setup
        ;;
    configure)
        cmd_configure
        ;;
    -h|--help|help|"")
        show_help
        ;;
    *)
        echo "âŒ ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð°: $1"
        show_help
        exit 1
        ;;
esac
