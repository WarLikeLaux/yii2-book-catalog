#!/usr/bin/env php
<?php

declare(strict_types=1);

/**
 * –í–∞–ª–∏–¥–∞—Ç–æ—Ä –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ (README.md, docs/ai/contract.md)
 */

$root = dirname(__DIR__);
$readmePath = $root . '/README.md';
$makefilePath = $root . '/Makefile';
$contractPath = $root . '/docs/ai/contract.md';

$errors = [];

// 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ñ–∞–π–ª–æ–≤
if (!file_exists($readmePath)) {
    $errors[] = "–§–∞–π–ª README.md –Ω–µ –Ω–∞–π–¥–µ–Ω";
}
if (!file_exists($contractPath)) {
    $errors[] = "–§–∞–π–ª docs/ai/contract.md –Ω–µ –Ω–∞–π–¥–µ–Ω";
}

if ($errors) {
    echo "\033[31m[–û–®–ò–ë–ö–ê]\033[0m –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç:\n" . implode("\n", $errors) . "\n";
    exit(1);
}

$readme = file_get_contents($readmePath);
$makefile = file_get_contents($makefilePath);

echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏...\n";

// 2. –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥ Makefile –≤ README.md
preg_match_all('/^([a-zA-Z0-9_-]+):/m', $makefile, $matches);
$makeCommands = array_filter($matches[1], fn($cmd) => !in_array($cmd, ['.PHONY', 'all', 'help']));

foreach ($makeCommands as $cmd) {
    if (!str_contains($readme, "make $cmd")) {
        // –ö–æ–º–∞–Ω–¥—ã, –∫–æ—Ç–æ—Ä—ã–µ –º—ã –º–æ–∂–µ–º —Ä–∞–∑—Ä–µ—à–∏—Ç—å –Ω–µ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å (–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ –∏–ª–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ)
        if (in_array($cmd, [
             'rector-fix', 'lint-fix', 'ps', 'logs', 'shell', 
             'restart', 'composer', 'migrate', 'perms', 'copy-env', 
             'queue-info', '_test-init', 'docs', 'repomix', 'infection',
             'swagger', 'load-test', 'sms-logs', 'seed'
        ])) {
            continue;
        }
        $errors[] = "–ö–æ–º–∞–Ω–¥–∞ `make $cmd` –Ω–∞–π–¥–µ–Ω–∞ –≤ Makefile, –Ω–æ –Ω–µ –æ–ø–∏—Å–∞–Ω–∞ –≤ README.md";
    }
}

// 3. –í–∞–ª–∏–¥–∞—Ü–∏—è –º–µ—Ç—Ä–∏–∫
if (!str_contains($readme, '## –ú–µ—Ç—Ä–∏–∫–∏') && !str_contains($readme, '## Metrics') && !str_contains($readme, '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ')) {
    $errors[] = "–í README.md –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å–µ–∫—Ü–∏—è —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏ (Metrics / –ú–µ—Ç—Ä–∏–∫–∏ / –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)";
}

// 4. –í–∞–ª–∏–¥–∞—Ü–∏—è –ö–æ–Ω—Ç—Ä–∞–∫—Ç–∞
$contract = file_get_contents($contractPath);
$requiredWorkflows = ['commit.md', 'changelog.md', 'readme.md'];
foreach ($requiredWorkflows as $wf) {
    if (!str_contains($contract, $wf)) {
        $errors[] = "–í AI –ö–æ–Ω—Ç—Ä–∞–∫—Ç–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤–æ—Ä–∫—Ñ–ª–æ—É `$wf`";
    }
}

// 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ (—Ñ–æ—Ä–º–∞—Ç vX)
if (!preg_match('/\*v\d+.*?\*/', $contract)) {
    $errors[] = "–í –∫–æ–Ω—Ü–µ –ö–æ–Ω—Ç—Ä–∞–∫—Ç–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —É–∫–∞–∑–∞–Ω–∞ –≤–µ—Ä—Å–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ `*v1 (–¥–∞—Ç–∞)*`";
}

if ($errors) {
    echo "\033[31m[–ü–†–û–í–ê–õ]\033[0m –ù–∞–π–¥–µ–Ω—ã –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:\n";
    foreach ($errors as $error) {
        echo "  - $error\n";
    }
    exit(1);
}

echo "\033[32m[–£–°–ü–ï–•]\033[0m –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–∞.\n";
exit(0);
