#!/usr/bin/env php
<?php

declare(strict_types=1);

$root = dirname(__DIR__);
$readmePath = $root . '/README.md';
$makefilePath = $root . '/Makefile';
$contractPath = $root . '/docs/ai/contract.md';

if (!file_exists($readmePath) || !file_exists($contractPath)) {
    exit(1);
}

$readme = file_get_contents($readmePath);
$makefile = file_get_contents($makefilePath);
$contract = file_get_contents($contractPath);
$errors = [];

preg_match_all('/^([a-zA-Z0-9_-]+):/m', $makefile, $matches);
$makeCommands = array_filter($matches[1], fn($cmd) => !in_array($cmd, ['.PHONY', 'all', 'help']));
$ignored = [
    'rector-fix', 'lint-fix', 'ps', 'logs', 'shell', 'restart', 'composer', 'migrate', 
    'perms', 'copy-env', 'queue-info', '_test-init', 'docs', 'repomix', 'infection',
    'swagger', 'load-test', 'sms-logs', 'seed'
];

foreach ($makeCommands as $cmd) {
    if (!in_array($cmd, $ignored) && !str_contains($readme, "make $cmd")) {
        $errors[] = "Команда Makefile `make $cmd` не описана в README.md";
    }
}

$realFileCount = (int)shell_exec("find . -name '*.php' -not -path './vendor/*' -not -path './runtime/*' | wc -l");
if (preg_match('/PHP_Files-(\d+)-/', $readme, $matches)) {
    $documentedFiles = (int)$matches[1];
    if (abs($realFileCount - $documentedFiles) > 10) {
        $errors[] = "Количество PHP-файлов в README ($documentedFiles) сильно расходится с реальным ($realFileCount)";
    }
}

if (!preg_match('/Coverage-\d+%/', $readme)) {
    $errors[] = "В README.md отсутствует бейдж или значение покрытия (Coverage)";
}
if (!preg_match('/Tests-\d+_passed/', $readme)) {
    $errors[] = "В README.md отсутствует бейдж или значение пройденных тестов (Tests passed)";
}

foreach (['commit.md', 'changelog.md', 'readme.md'] as $wf) {
    if (!str_contains($contract, $wf)) {
        $errors[] = "В AI Контракте отсутствует ссылка на обязательный воркфлоу: $wf";
    }
}

if (!str_contains($contract, '--amend')) {
    $errors[] = "В AI Контракте должен быть явный запрет на использование git commit --amend";
}

if ($errors) {
    echo "\033[31m[ПРОВАЛ]\033[0m Ошибки синхронизации документации:\n";
    foreach ($errors as $error) {
        echo "  - $error\n";
    }
    exit(1);
}

echo "\033[32m[ОК]\033[0m Документация актуальна.\n";
exit(0);
