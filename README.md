# Yii2 Library System (Clean Architecture Demo)

–ü—Ä–æ–µ–∫—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –∫–∞—Ç–∞–ª–æ–≥–∞ –∫–Ω–∏–≥ –Ω–∞ –±–∞–∑–µ **Yii2 Basic** –∏ **PHP 8.4** —Å **clean-ish** –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π.

–û—Å–Ω–æ–≤–Ω–æ–π –∞–∫—Ü–µ–Ω—Ç —Å–¥–µ–ª–∞–Ω –Ω–∞ **–æ—Ç–¥–µ–ª–µ–Ω–∏–∏ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ –æ—Ç —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞**, —Å—Ç—Ä–æ–≥–æ–π —Ç–∏–ø–∏–∑–∞—Ü–∏–∏ –∏ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤. –ü—Ä–æ–¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –∫–æ–º–ø—Ä–æ–º–∏—Å—Å–Ω—ã–π –ø–æ–¥—Ö–æ–¥: Yii –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è, –∞ use cases –∏ –ø–æ—Ä—Ç—ã –∂–∏–≤—É—Ç –æ—Ç–¥–µ–ª—å–Ω–æ.

## üõ† –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

*   **PHP:** 8.4 (Strict Types, Constructor Promotion, Readonly Classes).
*   **Framework:** Yii2 Basic.
*   **Database:** MySQL 8.0 (InnoDB + FullText Search).
*   **Async:** `yii2-queue` (DB driver) —Å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π Fan-out –ø–∞—Ç—Ç–µ—Ä–Ω–∞.
*   **Search:** Hybrid SQL Search (FullText + Exact Match) + PJAX.
*   **Testing:** Codeception (Unit).
*   **Infra:** Docker Compose + Makefile.

## üèó –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

### 1. Application Layer (Use Cases, CQS, Ports)
–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω **CQS (Command Query Separation)** –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ –ø–æ—Ä—Ç—ã:
*   **Write Side (–ö–æ–º–∞–Ω–¥—ã):** –û–ø–µ—Ä–∞—Ü–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–Ω–∫–∞–ø—Å—É–ª–∏—Ä–æ–≤–∞–Ω—ã –≤ **Use Cases** (`CreateBookUseCase`, `SubscribeUseCase`). –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å—Ç—Ä–æ–≥–æ —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —á–µ—Ä–µ–∑ **Command DTO** (`CreateBookCommand`).
*   **Read Side (–ó–∞–ø—Ä–æ—Å—ã):** –ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ—Ç–¥–µ–ª–µ–Ω–æ –æ—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏. **QueryServices** –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç DTO (`BookReadDto`) –∏ `PagedResult` –≤–º–µ—Å—Ç–æ ActiveRecord –º–æ–¥–µ–ª–µ–π.
*   **Ports:** –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤ –∏ –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ `app/application/ports`.
*   **–ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã:** –¢–æ–Ω–∫–∏–µ, —Ç–æ–ª—å–∫–æ –º–∞–ø–ø–∏–Ω–≥ HTTP -> –∫–æ–º–∞–Ω–¥–∞/criteria –∏ –≤—ã–∑–æ–≤ use case/query.

### 2. Domain vs ActiveRecord (Clean-ish –∫–æ–º–ø—Ä–æ–º–∏—Å—Å)
–î–æ–º–µ–Ω–Ω—ã–π —Å–ª–æ–π –Ω–∞–º–µ—Ä–µ–Ω–Ω–æ –º–∏–Ω–∏–º–∞–ª–µ–Ω: –±–∏–∑–Ω–µ—Å-–æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —á–µ—Ä–µ–∑ use cases –∏ –ø–æ—Ä—Ç—ã, –∞ ActiveRecord –æ—Å—Ç–∞–µ—Ç—Å—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –¥–∞–Ω–Ω—ã—Ö –∏ –ø—Ä–∞–≤–∏–ª –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã. –≠—Ç–æ –æ—Å–æ–∑–Ω–∞–Ω–Ω—ã–π –∫–æ–º–ø—Ä–æ–º–∏—Å—Å –¥–ª—è Yii2, —á—Ç–æ–±—ã –Ω–µ —Ç–∞—â–∏—Ç—å —Ç—è–∂–µ–ª—ã–π –º–∞–ø–ø–∏–Ω–≥.

### 3. Presentation Layer (Yii2)
*   **Controllers + Forms:** –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ `FormModel`.
*   **Mappers:** –ü–µ—Ä–µ–≤–æ–¥ —Ñ–æ—Ä–º –≤ –∫–æ–º–∞–Ω–¥—ã/criteria –∏ –æ–±—Ä–∞—Ç–Ω–æ.
*   **Adapters:** `PagedResult` –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç—Å—è –≤ `DataProvider` –±–µ–∑ –ª–æ–≥–∏–∫–∏ –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞—Ö.

### 4. DTO & Forms –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
–°–ª–æ–π –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –æ—Ç–¥–µ–ª–µ–Ω –æ—Ç –¥–æ–º–µ–Ω–∞.
*   **Forms (`app/models/forms`):** –í–∞–ª–∏–¥–∏—Ä—É—é—Ç —Å—ã—Ä—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ (HTTP request).
*   **DTO (`app/application/**/commands`):** –ü–µ—Ä–µ–¥–∞—é—Ç —É–∂–µ –≤–∞–ª–∏–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —è–¥—Ä–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
*   –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É —Ñ–∞–π–ª–æ–≤ –∏ —Å–ª–æ–∂–Ω—É—é –ª–æ–≥–∏–∫—É –±–µ–∑ –∑–∞—Å–æ—Ä–µ–Ω–∏—è –¥–æ–º–µ–Ω–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π –ø—Ä–∞–≤–∏–ª–∞–º–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ñ–æ—Ä–º.

### 5. Infrastructure Layer
*   **ActiveRecord –∏ DB:** –†–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ—Ä—Ç–æ–≤ –∂–∏–≤—É—Ç –≤ `app/infrastructure`.
*   **Queue/File Storage:** –ü–æ–¥–∫–ª—é—á–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –∏ DI.

### 6. Code Quality & Standards
*   **Strict Types:** –í–µ—Å—å –ø—Ä–æ–µ–∫—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ä–µ–∂–∏–º–µ `declare(strict_types=1)`.
*   **Static Analysis:** –í–Ω–µ–¥—Ä–µ–Ω Advanced Coding Standard (–Ω–∞ –±–∞–∑–µ **Slevomat**).
*   **Linter:** –ö–æ–¥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç—Å—è –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –∫–æ–º–∞–Ω–¥–æ–π `make lint-fix`.

### 7. –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–∞—è –æ—á–µ—Ä–µ–¥—å (Fan-out Pattern)
–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ –æ –≤—ã—Ö–æ–¥–µ –∫–Ω–∏–≥.
*   **–ü—Ä–æ–±–ª–µ–º–∞:** –û—Ç–ø—Ä–∞–≤–∫–∞ SMS —Ç—ã—Å—è—á–∞–º –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ –≤ –æ–¥–Ω–æ–º Job-–µ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ —Ç–∞–π–º-–∞—É—Ç–∞–º –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ –≤–æ—Ä–∫–µ—Ä–∞.
*   **–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–∞—Ç—Ç–µ—Ä–Ω **Fan-out**.
    1.  `NotifySubscribersJob` (Dispatcher) –Ω–∞—Ö–æ–¥–∏—Ç —Ü–µ–ª–µ–≤—É—é –∞—É–¥–∏—Ç–æ—Ä–∏—é –∏ –Ω–∞—Ä–µ–∑–∞–µ—Ç –∑–∞–¥–∞—á–∏ –±–∞—Ç—á–∞–º–∏.
    2.  –°–æ–∑–¥–∞—é—Ç—Å—è —Ç—ã—Å—è—á–∏ –ª–µ–≥–∫–∏—Ö `NotifySingleSubscriberJob` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—è.
*   **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ò–∑–æ–ª—è—Ü–∏—è –æ—à–∏–±–æ–∫ (—Å–±–æ–π –æ–¥–Ω–æ–≥–æ SMS –Ω–µ –ª–æ–º–∞–µ—Ç —Ä–∞—Å—Å—ã–ª–∫—É) –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –≤–æ—Ä–∫–µ—Ä–∞–º–∏.

### 8. –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫ (Universal Search)
–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω "—É–º–Ω—ã–π" –ø–æ–∏—Å–∫ –ø–æ –∫–∞—Ç–∞–ª–æ–≥—É –±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤–Ω–µ—à–Ω–∏—Ö –¥–≤–∏–∂–∫–æ–≤ (Elasticsearch), –Ω–æ —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π –ø–æ–¥ MySQL.
*   **FullText Index:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ `title` –∏ `description` (O(1)).
*   **Exact Match:** –î–ª—è ISBN –∏ –ì–æ–¥–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–æ—á–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è.
*   **UX:** –û–±–µ—Ä–Ω—É—Ç–æ –≤ **PJAX** –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã.

### 9. Dependency Injection
–í–Ω–µ—à–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∑–∞–∫—Ä—ã—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞–º–∏ –∏ –ø–æ—Ä—Ç–∞–º–∏ (`app/interfaces`, `app/application/ports`):
*   `SmsSenderInterface`: –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø—Ä–æ–∑—Ä–∞—á–Ω–æ –º–µ–Ω—è—Ç—å –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ (Smspilot / Mock).
*   `FileStorageInterface`: –ê–±—Å—Ç—Ä–∞–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ (Local / S3).

## üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫

–ü—Ä–æ–µ–∫—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∏—Ä–æ–≤–∞–Ω. –í—Å–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ `Makefile`.

### –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏, –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –∏ –Ω–∞–ø–æ–ª–Ω–∏—Ç—å –±–∞–∑—É —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏:

```bash
make init
```

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ –∞–¥—Ä–µ—Å—É: [http://localhost:8000](http://localhost:8000)

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
–ó–∞–ø—É—Å–∫ Unit-—Ç–µ—Å—Ç–æ–≤ (–ø–æ–∫—Ä—ã–≤–∞—é—Ç —Å–µ—Ä–≤–∏—Å–Ω—ã–π —Å–ª–æ–π, –≤–∞–ª–∏–¥–∞—Ü–∏—é –∏ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É):

```bash
make test
```

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

| –ö–æ–º–∞–Ω–¥–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|---|---|
| `make up` / `make down` | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏ |
| `make seed` | –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–µ–º–æ-–¥–∞–Ω–Ω—ã—Ö (–ö–Ω–∏–≥–∏, –ê–≤—Ç–æ—Ä—ã) |
| `make lint-fix` | –ê–≤—Ç–æ-—Ñ–∏–∫—Å —Å—Ç–∏–ª—è –∫–æ–¥–∞ (PHPCS) |
| `make queue-info` | –°—Ç–∞—Ç—É—Å –æ—á–µ—Ä–µ–¥–∏ –∑–∞–¥–∞—á |
| `make sms-logs` | –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ –æ—Ç–ø—Ä–∞–≤–∫–∏ SMS (Mock) |
| `make shell` | –ö–æ–Ω—Å–æ–ª—å PHP –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ |

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ —Ñ–∞–π–ª–µ `.env`.
*   `SMS_API_KEY`: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ `MOCK_KEY` –¥–ª—è —ç–º—É–ª—è—Ü–∏–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ (–∑–∞–ø–∏—Å—å –≤ –ª–æ–≥) –∏–ª–∏ —Ä–µ–∞–ª—å–Ω—ã–π –∫–ª—é—á.
